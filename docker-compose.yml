version: '3'

services:
  # Ethereum Node - Fast dev chain with preloaded ETH
  ethereum:
    image: ethereum/client-go:stable
    container_name: ethereum-node
    command:
      - --dev
      - --http
      - --http.addr=0.0.0.0
      - --http.api=eth,net,web3,personal,miner,admin,debug,txpool
      - --http.corsdomain=*
      - --http.vhosts=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.origins=*
      - --ws.api=eth,net,web3,personal,miner,admin,debug,txpool
      - --networkid=1337
      - --allow-insecure-unlock
      - --rpc.allow-unprotected-txs
    ports:
      - "8545:8545"  # HTTP RPC
      - "8546:8546"  # WS RPC
    volumes:
      - geth-data:/root/.ethereum
      
  # Simple Block Explorer
  explorer:
    image: alethio/ethereum-lite-explorer:latest
    container_name: eth-explorer
    environment:
      - APP_NODE_URL=http://146.190.176.30:8545
    ports:
      - "8080:80"
    depends_on:
      - ethereum
      
  # Blockscout Explorer - Advanced explorer with smart contract interaction
  blockscout:
    image: blockscout/blockscout:latest
    container_name: blockscout-explorer
    restart: always
    depends_on:
      - ethereum
      - postgres
    environment:
      ETHEREUM_JSONRPC_VARIANT: 'geth'
      ETHEREUM_JSONRPC_HTTP_URL: http://ethereum:8545
      ETHEREUM_JSONRPC_WS_URL: ws://ethereum:8546
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/blockscout
      ECTO_USE_SSL: 'false'
      SECRET_KEY_BASE: "56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN"
      PORT: 4000
      COIN: "ETH"
      NETWORK: "Akadal Chain"
      SUBNETWORK: "Blockchain Course"
      LOGO: "/images/blockscout_logo.svg"
      CHAIN_ID: 1337
    ports:
      - "4000:4000"
      
  # Database for Blockscout Explorer
  postgres:
    image: postgres:14-alpine
    container_name: postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: blockscout
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      
  # Faucet - Web UI to distribute test ETH to students
  faucet:
    build:
      context: ./faucet
      dockerfile: Dockerfile
    container_name: eth-faucet
    environment:
      RPC_URL: http://ethereum:8545
      CHAIN_ID: 1337
      ETH_AMOUNT: "100"
      FUND_PRIVATE_KEY: "0x4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d"
      FUND_ADDRESS: "0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1"
      FAUCET_NAME: "Akadal Chain Faucet"
      FAUCET_DESCRIPTION: "Blockchain course test tokens"
      EXPLORER_URL: "http://146.190.176.30:8080"
      BLOCKSCOUT_URL: "http://146.190.176.30:4000"
    ports:
      - "3000:3000"
    depends_on:
      - ethereum

volumes:
  geth-data:
  postgres-data: 